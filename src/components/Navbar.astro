---
import Gear from './icons/Gear.astro';
import Cat from './icons/Cat.astro';
import Search from './Search.astro';
import { getFrameworkFromPath } from '../config/frameworks.js';

// Extend Window interface for openSettings
declare global {
  interface Window {
    openSettings?: () => void;
  }
}

interface Props {
  siteName?: string;
  logo?: string;
}

const { siteName = 'Rizzo CSS', logo } = Astro.props;

// Get current URL pathname and framework for component links only
const currentPath = Astro.url.pathname;
const { framework } = getFrameworkFromPath(currentPath);
const docsPrefix = framework.pathPrefix;

/** Use only for component routes; docs and themes are general (no framework prefix). */
function componentHref(path: string): string {
  if (!path.startsWith('/docs')) return path;
  return docsPrefix + path.slice('/docs'.length) || docsPrefix || '/';
}

const navLinks: Array<{ href: string; label: string }> = [
  { href: '/docs/getting-started', label: 'Docs' },
  { href: componentHref('/docs/components'), label: 'Components' },
  { href: '/blocks', label: 'Blocks' },
  { href: '/themes', label: 'Themes' },
  { href: '/docs/colors', label: 'Colors' },
];
---

<nav class="navbar" role="navigation" aria-label="Main navigation">
  <div class="navbar__container">
    <div class="navbar__brand">
      <a href="/" class="navbar__brand-link" aria-label={`${siteName} home`}>
        {logo ? (
          <img src={logo} alt="" class="navbar__logo" />
        ) : (
          <Cat width={32} height={32} class="navbar__logo" aria-hidden="true" />
        )}
        {siteName}
      </a>
    </div>
    
    <div class="navbar__actions-desktop">
      <Search />
      <div class="tooltip-wrapper" aria-describedby="navbar-settings-tooltip">
        <button
          class="navbar__settings-btn"
          type="button"
          aria-label="Open settings"
          onclick="window.openSettings && window.openSettings()"
        >
          <Gear class="navbar__settings-icon" width={20} height={20} />
          <span class="navbar__settings-label">Settings</span>
        </button>
        <span class="tooltip tooltip--bottom" id="navbar-settings-tooltip" role="tooltip" aria-hidden="true">Settings</span>
      </div>
    </div>
    
    <button
      class="navbar__toggle"
      type="button"
      aria-expanded="false"
      aria-controls="navbar-menu"
      aria-label="Toggle navigation menu"
      id="navbar-toggle"
    >
      <span class="sr-only">Menu</span>
      <span class="navbar__toggle-icon" aria-hidden="true">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </button>
    
    <div class="navbar__menu" id="navbar-menu" role="navigation" aria-label="Mobile navigation">
      {navLinks.map((link) => {
        const isActive = currentPath === link.href || (link.href !== '/' && currentPath.startsWith(link.href));
        return (
          <div class="navbar__item">
            <a
              href={link.href}
              class="navbar__link"
              aria-label={link.label}
              aria-current={isActive ? 'page' : undefined}
            >
              {link.label}
            </a>
          </div>
        );
      })}
    </div>
  </div>
</nav>

<script>
  function initNavbar() {
    const navbar = document.querySelector('.navbar');
    if (!navbar) return;

    const menuToggleBtn = document.getElementById('navbar-toggle');
    const menu = navbar.querySelector('.navbar__menu');
    
    if (!menuToggleBtn || !menu) return;

    const toggleMenu = (open?: boolean) => {
      const isOpen = open !== undefined ? open : menu.classList.contains('navbar__menu--open');
      const willBeOpen = !isOpen;
      
      // On mobile, close search if it's open when opening menu
      const isMobile = window.innerWidth <= 1023;
      if (isMobile && !isOpen) {
        // Menu is about to open, close any open search instance
        document.querySelectorAll('[data-search]').forEach((search) => {
          const panel = search.querySelector('.search__panel');
          if (panel?.getAttribute('aria-hidden') === 'false') {
            const el = search as Element & { __searchInstance?: { closeSearch?: () => void } };
            if (el?.__searchInstance?.closeSearch) {
              el.__searchInstance.closeSearch();
            } else {
              const overlay = search.querySelector('[data-search-overlay]');
              if (overlay instanceof HTMLElement) overlay.click();
            }
          }
        });
      }
      
      // Toggle class on navbar to hide/show bottom border
      if (willBeOpen) {
        navbar.classList.add('navbar--menu-open');
      } else {
        navbar.classList.remove('navbar--menu-open');
      }
      
      menu.classList.toggle('navbar__menu--open', !isOpen);
      menuToggleBtn.setAttribute('aria-expanded', (!isOpen).toString());
    };

    menuToggleBtn.addEventListener('click', () => toggleMenu());

    // Close menu when a nav link is clicked (links work normally; right-click context menu works)
    navbar.addEventListener('click', (e: Event) => {
      const target = (e.target as Element).closest('a.navbar__link');
      if (target && menu.classList.contains('navbar__menu--open')) {
        toggleMenu(false);
      }
    });

    // Close menu on outside click
    document.addEventListener('click', (e) => {
      const target = e.target as Node | null;
      if (target && !navbar.contains(target as Node)) {
        menu.classList.remove('navbar__menu--open');
        menuToggleBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Close menu on Escape key
    document.addEventListener('keydown', (e: Event) => {
      const keyEvent = e as KeyboardEvent;
      if (keyEvent.key === 'Escape' && menu.classList.contains('navbar__menu--open')) {
        toggleMenu(false);
        menuToggleBtn.focus();
      }
    });

    // Settings button keyboard handler
    const settingsBtn = navbar.querySelector('.navbar__settings-btn');
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        if (window.openSettings) {
          window.openSettings();
        }
      });
      settingsBtn.addEventListener('keydown', (e: Event) => {
        const keyEvent = e as KeyboardEvent;
        if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {
          keyEvent.preventDefault();
          if (window.openSettings) {
            window.openSettings();
          }
        }
      });
    }

    // Handle window resize
    let resizeTimer: ReturnType<typeof setTimeout> | undefined;
    window.addEventListener('resize', () => {
      if (resizeTimer) clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (window.innerWidth >= 1024) {
          menu.classList.remove('navbar__menu--open');
          menuToggleBtn.setAttribute('aria-expanded', 'false');
        }
      }, 250);
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNavbar);
  } else {
    initNavbar();
  }
</script>

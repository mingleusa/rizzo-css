---
import ThemeSwitcher from './ThemeSwitcher.astro';
import Close from './icons/Close.astro';

interface Props {
  open?: boolean;
}

const { open = false } = Astro.props;
---

<div class="settings" data-settings aria-hidden={open ? 'false' : 'true'}>
  <div class="settings__overlay" data-settings-overlay aria-hidden="true"></div>
  
  <div class="settings__panel" role="dialog" aria-modal="true" aria-labelledby="settings-title" aria-hidden={open ? 'false' : 'true'}>
    <div class="settings__header">
      <h2 id="settings-title" class="settings__title">Settings</h2>
      <button
        class="settings__close"
        type="button"
        aria-label="Close settings"
        data-settings-close
      >
        <Close width={20} height={20} />
      </button>
    </div>

    <div class="settings__content">
      <!-- Theme Section -->
      <section class="settings__section">
        <h3 class="settings__section-title">Theme</h3>
        <div class="settings__control">
          <ThemeSwitcher />
        </div>
      </section>

      <!-- Font Size Section -->
      <section class="settings__section">
        <h3 class="settings__section-title">Font Size</h3>
        <div class="settings__control">
          <label for="font-size-slider" class="settings__label">
            <span class="settings__label-text">Adjust text size</span>
            <span class="settings__label-value" data-font-size-value>100%</span>
          </label>
          <input
            type="range"
            id="font-size-slider"
            class="settings__slider"
            min="0.75"
            max="1.5"
            step="0.05"
            value="1"
            aria-label="Font size"
            data-font-size-slider
            style="--slider-progress: 50%;"
          />
          <div class="settings__slider-labels">
            <span>Small</span>
            <span>Default</span>
            <span>Large</span>
          </div>
        </div>
      </section>

      <!-- Accessibility Section -->
      <section class="settings__section">
        <h3 class="settings__section-title">Accessibility</h3>
        
        <div class="settings__control">
          <label class="settings__checkbox-label">
            <input
              type="checkbox"
              class="settings__checkbox"
              data-reduced-motion
              aria-label="Reduce motion"
            />
            <span>Reduce motion</span>
          </label>
          <p class="settings__help-text">Minimize animations and transitions</p>
        </div>

        <div class="settings__control">
          <label class="settings__checkbox-label">
            <input
              type="checkbox"
              class="settings__checkbox"
              data-high-contrast
              aria-label="High contrast"
            />
            <span>High contrast</span>
          </label>
          <p class="settings__help-text">Increase contrast for better visibility</p>
        </div>

        <div class="settings__control">
          <label class="settings__checkbox-label">
            <input
              type="checkbox"
              class="settings__checkbox"
              data-hide-scrollbars
              aria-label="Hide scrollbars"
            />
            <span>Hide scrollbars</span>
          </label>
          <p class="settings__help-text">Hide scrollbars while maintaining scroll functionality</p>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
  (function initSettings() {
    const settings = document.querySelector('[data-settings]');
    if (!settings) return;

    const overlay = settings.querySelector('[data-settings-overlay]');
    const panel = settings.querySelector('.settings__panel');
    const closeBtn = settings.querySelector('[data-settings-close]');
    const fontSizeSlider = settings.querySelector('[data-font-size-slider]');
    const fontSizeValue = settings.querySelector('[data-font-size-value]');
    const reducedMotion = settings.querySelector('[data-reduced-motion]');
    const highContrast = settings.querySelector('[data-high-contrast]');
    const hideScrollbars = settings.querySelector('[data-hide-scrollbars]');
    const html = document.documentElement;

    if (!panel || !overlay || !closeBtn) return;

    // Update slider progress fill
    const updateSliderProgress = (slider) => {
      const min = parseFloat(slider.min);
      const max = parseFloat(slider.max);
      const value = parseFloat(slider.value);
      const progress = ((value - min) / (max - min)) * 100;
      slider.style.setProperty('--slider-progress', `${progress}%`);
    };

    // Load saved settings
    const loadSettings = () => {
      const savedFontScale = localStorage.getItem('fontSizeScale');
      if (savedFontScale && fontSizeSlider) {
        fontSizeSlider.value = savedFontScale;
        const scale = parseFloat(savedFontScale);
        applyFontSize(scale);
        updateSliderProgress(fontSizeSlider);
      } else if (fontSizeSlider) {
        // Initialize with default value
        updateSliderProgress(fontSizeSlider);
      }

      const savedReducedMotion = localStorage.getItem('reducedMotion') === 'true';
      if (reducedMotion) {
        reducedMotion.checked = savedReducedMotion;
        html.classList.toggle('reduced-motion', savedReducedMotion);
      }

      const savedHighContrast = localStorage.getItem('highContrast') === 'true';
      if (highContrast) {
        highContrast.checked = savedHighContrast;
        html.classList.toggle('high-contrast', savedHighContrast);
      }

      const savedHideScrollbars = localStorage.getItem('hideScrollbars') === 'true';
      if (hideScrollbars) {
        hideScrollbars.checked = savedHideScrollbars;
        html.classList.toggle('hide-scrollbars', savedHideScrollbars);
      }
    };

    // Apply font size
    const applyFontSize = (scale) => {
      html.style.setProperty('--font-size-scale', scale.toString());
      if (fontSizeValue) {
        fontSizeValue.textContent = `${Math.round(scale * 100)}%`;
      }
    };

    // Focus trap helper
    const getFocusableElements = (container) => {
      const focusableSelectors = [
        'button:not([disabled])',
        'a[href]',
        'input:not([disabled])',
        'select:not([disabled])',
        'textarea:not([disabled])',
        '[tabindex]:not([tabindex="-1"])',
      ].join(', ');
      return Array.from(container.querySelectorAll(focusableSelectors));
    };

    let previousActiveElement = null;

    // Open settings
    const openSettings = () => {
      previousActiveElement = document.activeElement;
      settings.setAttribute('aria-hidden', 'false');
      if (overlay) overlay.setAttribute('aria-hidden', 'false');
      panel.setAttribute('aria-hidden', 'false');
      panel.setAttribute('data-open', 'true');
      if (closeBtn) closeBtn.focus();
    };

    // Close settings
    const closeSettings = () => {
      settings.setAttribute('aria-hidden', 'true');
      overlay?.setAttribute('aria-hidden', 'true');
      panel.setAttribute('aria-hidden', 'true');
      panel.removeAttribute('data-open');
      // Return focus to previous element
      if (previousActiveElement) {
        previousActiveElement.focus();
        previousActiveElement = null;
      }
    };

    // Event listeners
    closeBtn?.addEventListener('click', closeSettings);
    
    overlay?.addEventListener('click', closeSettings);

    // Focus trapping and keyboard handlers
    const handleKeyDown = (e: KeyboardEvent) => {
      if (panel.getAttribute('data-open') !== 'true') return;

      if (e.key === 'Escape') {
        e.preventDefault();
        closeSettings();
        return;
      }

      // Focus trap: Tab key
      if (e.key === 'Tab') {
        const focusableElements = getFocusableElements(panel);
        if (focusableElements.length === 0) return;

        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        const activeElement = document.activeElement as HTMLElement;

        if (e.shiftKey) {
          // Shift + Tab: move backwards
          if (activeElement === firstElement || !panel.contains(activeElement)) {
            e.preventDefault();
            lastElement.focus();
          }
        } else {
          // Tab: move forwards
          if (activeElement === lastElement || !panel.contains(activeElement)) {
            e.preventDefault();
            firstElement.focus();
          }
        }
      }
    };

    document.addEventListener('keydown', handleKeyDown);

    // Font size slider
    if (fontSizeSlider) {
      fontSizeSlider.addEventListener('input', (e) => {
        const target = e.target;
        const scale = parseFloat(target.value);
        applyFontSize(scale);
        updateSliderProgress(target);
        localStorage.setItem('fontSizeScale', scale.toString());
      });
    }

    // Reduced motion
    if (reducedMotion) {
      reducedMotion.addEventListener('change', (e) => {
        const target = e.target;
        html.classList.toggle('reduced-motion', target.checked);
        localStorage.setItem('reducedMotion', target.checked.toString());
      });
    }

    // High contrast
    if (highContrast) {
      highContrast.addEventListener('change', (e) => {
        const target = e.target;
        html.classList.toggle('high-contrast', target.checked);
        localStorage.setItem('highContrast', target.checked.toString());
      });
    }

    // Hide scrollbars
    if (hideScrollbars) {
      hideScrollbars.addEventListener('change', (e) => {
        const target = e.target;
        html.classList.toggle('hide-scrollbars', target.checked);
        localStorage.setItem('hideScrollbars', target.checked.toString());
      });
    }

    // Load settings on init
    loadSettings();

    // Expose open function globally
    window.openSettings = openSettings;
  })();
</script>

---
import Close from './icons/Close.astro';

interface Props {
  variant?: 'success' | 'error' | 'warning' | 'info';
  dismissible?: boolean;
  autoDismiss?: number; // Duration in milliseconds (0 = disabled)
  class?: string;
  id?: string;
}

const {
  variant = 'info',
  dismissible = false,
  autoDismiss = 0, // 0 means disabled
  class: className = '',
  id,
} = Astro.props;

const alertId = id || `alert-${Math.random().toString(36).substr(2, 9)}`;
const variantClass = `alert--${variant}`;
const classes = `alert ${variantClass} ${className}`.trim();

// ARIA labels based on variant
const ariaLabels = {
  success: 'Success message',
  error: 'Error message',
  warning: 'Warning message',
  info: 'Information message',
};
---

<div
  class={classes}
  id={alertId}
  role="alert"
  aria-live="polite"
  aria-atomic="true"
  aria-label={ariaLabels[variant]}
>
  <div class="alert__content">
    <slot />
  </div>
  {dismissible && (
    <button
      type="button"
      class="alert__close"
      aria-label="Dismiss alert"
      data-alert-close
      aria-controls={alertId}
    >
      <Close width={16} height={16} />
    </button>
  )}
</div>

<script define:vars={{ alertId, autoDismiss }}>
  (function initAlert() {
    const init = () => {
      const alert = document.querySelector(`#${alertId}`);
      if (!alert) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
          return;
        }
        return;
      }
      
      // Skip if already initialized
      if (alert.hasAttribute('data-alert-initialized')) return;
      alert.setAttribute('data-alert-initialized', 'true');
      
      const closeBtn = alert.querySelector('[data-alert-close]');
      
      let closeAlert = () => {
        // Announce dismissal to screen readers
        const announcement = document.createElement('div');
        announcement.setAttribute('role', 'status');
        announcement.setAttribute('aria-live', 'polite');
        announcement.className = 'sr-only';
        announcement.textContent = 'Alert dismissed';
        document.body.appendChild(announcement);
        
        // Remove alert with animation
        alert.style.opacity = '0';
        alert.style.transform = 'translateY(-10px)';
        
        setTimeout(() => {
          alert.remove();
          if (document.body.contains(announcement)) {
            document.body.removeChild(announcement);
          }
        }, 200);
      };
      
      // Auto-dismiss functionality
      if (autoDismiss > 0) {
        const timeoutId = setTimeout(() => {
          closeAlert();
        }, autoDismiss);
        
        // Clear timeout if user manually dismisses
        if (closeBtn) {
          const originalClose = closeAlert;
          closeAlert = () => {
            clearTimeout(timeoutId);
            originalClose();
          };
        }
      }
      
      if (closeBtn) {
        closeBtn.addEventListener('click', closeAlert);
        
        // Keyboard support
        closeBtn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            closeAlert();
          }
        });
      }
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

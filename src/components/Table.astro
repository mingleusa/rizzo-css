---
import Sort from './icons/Sort.astro';
import Filter from './icons/Filter.astro';

export interface TableColumn {
  key: string;
  label: string;
  sortable?: boolean;
  type?: 'string' | 'number';
}

interface Props {
  /** Column definitions (key, label, sortable, type) */
  columns: TableColumn[];
  /** Row data: array of objects with keys matching column keys */
  data: Record<string, string | number>[];
  /** Table caption for accessibility */
  caption?: string;
  /** Enable column header sorting (default: true) */
  sortable?: boolean;
  /** Enable filter input above table (default: false) */
  filterable?: boolean;
  /** Placeholder for filter input */
  filterPlaceholder?: string;
  /** Striped rows (default: true) */
  striped?: boolean;
  class?: string;
}

const {
  columns,
  data,
  caption,
  sortable = true,
  filterable = false,
  filterPlaceholder = 'Filter tableâ€¦',
  striped = true,
  class: className = '',
} = Astro.props;

const tableId = `table-${Math.random().toString(36).slice(2, 11)}`;
const stripClass = striped ? 'table--striped' : '';
const sortClass = sortable ? 'table--sortable' : '';
const filterClass = filterable ? 'table--filterable' : '';
const classes = `table ${stripClass} ${sortClass} ${filterClass} ${className}`.trim();
---

<div class={classes} data-table-sortable={sortable ? 'true' : undefined} data-table-filterable={filterable ? 'true' : undefined} data-table-id={tableId}>
  {filterable && (
    <div class="table__filter-wrap">
      <label for={`${tableId}-filter`} class="sr-only">Filter table</label>
      <span class="table__filter-icon" aria-hidden="true">
        <Filter width={20} height={20} class="table__filter-icon-svg" />
      </span>
      <input
        type="search"
        id={`${tableId}-filter`}
        class="table__filter"
        placeholder={filterPlaceholder}
        aria-controls={tableId}
        data-table-filter
        autocomplete="off"
      />
    </div>
  )}
  <div class="table__wrapper">
    <table class="table__table" id={tableId}>
      {caption && <caption class="table__caption">{caption}</caption>}
      <thead class="table__head">
        <tr class="table__row">
          {columns.map((col, i) => (
            <th
              class="table__cell table__cell--head"
              scope="col"
              data-column-index={i}
              data-sortable={sortable && col.sortable !== false ? 'true' : undefined}
              data-type={col.type ?? 'string'}
              aria-sort={sortable && col.sortable !== false ? 'none' : undefined}
            >
              {sortable && col.sortable !== false ? (
                <button
                  type="button"
                  class="table__sort-trigger"
                  data-column-index={i}
                  aria-label={`Sort by ${col.label}`}
                >
                  <span class="table__cell-content">{col.label}</span>
                  <span class="table__sort-icon" aria-hidden="true">
                    <Sort width={20} height={20} class="table__sort-icon-svg" />
                  </span>
                </button>
              ) : (
                <>
                  <span class="table__cell-content">{col.label}</span>
                </>
              )}
            </th>
          ))}
        </tr>
      </thead>
      <tbody class="table__body">
        {data.map((row, rowIndex) => (
          <tr class="table__row" data-row-index={rowIndex}>
            {columns.map((col) => (
              <td class="table__cell" data-column-key={col.key}>
                {row[col.key] ?? ''}
              </td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</div>

{(sortable || filterable) && (
  <script is:inline>
    (function() {
      function init() {
        document.querySelectorAll('[data-table-sortable="true"], [data-table-filterable="true"]').forEach(function(wrapper) {
          if (wrapper.hasAttribute('data-table-initialized')) return;
          wrapper.setAttribute('data-table-initialized', 'true');

          var table = wrapper.querySelector('table');
          var tbody = table && table.querySelector('tbody');
          var thead = table && table.querySelector('thead');
          var filterInput = wrapper.querySelector('[data-table-filter]');

          if (wrapper.getAttribute('data-table-sortable') === 'true' && thead && tbody) {
            thead.querySelectorAll('th[data-sortable="true"] button.table__sort-trigger').forEach(function(btn) {
              var th = btn.closest('th');
              var colIndex = parseInt(th.getAttribute('data-column-index'), 10);
              btn.addEventListener('click', function() { sortTable(tbody, colIndex, th); });
            });
          }

          if (wrapper.getAttribute('data-table-filterable') === 'true' && filterInput && tbody) {
            filterInput.addEventListener('input', function() {
              var q = (filterInput.value || '').trim().toLowerCase();
              tbody.querySelectorAll('tr').forEach(function(tr) {
                var text = Array.from(tr.querySelectorAll('td')).map(function(td) { return td.textContent || ''; }).join(' ').toLowerCase();
                tr.hidden = q ? text.indexOf(q) === -1 : false;
              });
            });
          }
        });

        function sortTable(tbody, colIndex, th) {
          var type = th.getAttribute('data-type') || 'string';
          var dir = th.getAttribute('aria-sort') === 'ascending' ? 'descending' : 'ascending';
          var rows = Array.from(tbody.querySelectorAll('tr'));

          rows.sort(function(a, b) {
            var aCell = a.querySelectorAll('td')[colIndex];
            var bCell = b.querySelectorAll('td')[colIndex];
            var aVal = aCell ? aCell.textContent : '';
            var bVal = bCell ? bCell.textContent : '';
            if (type === 'number') {
              var aNum = parseFloat(String(aVal).replace(/[^0-9.-]/g, '')) || 0;
              var bNum = parseFloat(String(bVal).replace(/[^0-9.-]/g, '')) || 0;
              return dir === 'ascending' ? aNum - bNum : bNum - aNum;
            }
            var cmp = String(aVal).localeCompare(String(bVal), undefined, { numeric: true });
            return dir === 'ascending' ? cmp : -cmp;
          });

          th.setAttribute('aria-sort', dir);
          var table = tbody.parentNode;
          if (table && table.querySelector) {
            table.querySelectorAll('thead th[data-sortable="true"]').forEach(function(h) {
              if (h !== th) h.setAttribute('aria-sort', 'none');
            });
          }
          rows.forEach(function(tr) { tbody.appendChild(tr); });
        }
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
      else init();
    })();
  </script>
)}

---
interface Props {
  /** Current value (0 to max) */
  value?: number;
  /** Maximum value (default: 100) */
  max?: number;
  /** Visual variant */
  variant?: 'primary' | 'success' | 'warning' | 'error' | 'info';
  /** Bar height size */
  size?: 'sm' | 'md' | 'lg';
  /** Show percentage or value label */
  showLabel?: boolean;
  /** Indeterminate (animated) state - ignores value */
  indeterminate?: boolean;
  /** Accessible label for the progress bar */
  label?: string;
  class?: string;
}

const {
  value = 0,
  max = 100,
  variant = 'primary',
  size = 'md',
  showLabel = false,
  indeterminate = false,
  label,
  class: className = '',
} = Astro.props;

const safeMax = max <= 0 ? 100 : max;
const clampedValue = indeterminate ? 0 : Math.max(0, Math.min(value, safeMax));
const percentage = indeterminate ? 0 : Math.round((clampedValue / safeMax) * 100);

const variantClass = `progress--${variant}`;
const sizeClass = `progress--${size}`;
const indeterminateClass = indeterminate ? 'progress--indeterminate' : '';
const classes = `progress ${variantClass} ${sizeClass} ${indeterminateClass} ${className}`.trim();

const ariaAttrs = indeterminate
  ? { 'aria-valuemin': 0, 'aria-valuemax': safeMax, 'aria-label': label ?? 'Loading', 'aria-valuetext': 'Loading' }
  : {
      'aria-valuenow': clampedValue,
      'aria-valuemin': 0,
      'aria-valuemax': safeMax,
      'aria-label': label ?? undefined,
    };

const barStyle = indeterminate ? {} : { width: `${percentage}%` };
---

<div
  class={classes}
  role="progressbar"
  {...ariaAttrs}
>
  <div class="progress__track">
    <div class="progress__bar" style={barStyle} />
  </div>
  {showLabel && !indeterminate && (
    <span class="progress__label" aria-hidden="true">
      {percentage}%
    </span>
  )}
</div>

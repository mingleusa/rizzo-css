---
import ChevronDown from './icons/ChevronDown.astro';

interface AccordionItem {
  id: string;
  title: string;
  content?: string;
}

interface Props {
  items: AccordionItem[];
  id?: string;
  allowMultiple?: boolean;
  defaultExpanded?: string | string[];
  class?: string;
}

const {
  items,
  id,
  allowMultiple = false,
  defaultExpanded,
  class: className = '',
} = Astro.props;

const accordionId = id || `accordion-${Math.random().toString(36).substr(2, 9)}`;

const getDefaultExpanded = (): Set<string> => {
  if (defaultExpanded === undefined) return new Set(items[0] ? [items[0].id] : []);
  if (typeof defaultExpanded === 'string') return new Set([defaultExpanded]);
  return new Set(defaultExpanded);
};

const defaultOpenIds = getDefaultExpanded();
const classes = `accordion ${className}`.trim();
let slotIndex = 0;
---

<div class={classes} data-accordion={accordionId} data-allow-multiple={allowMultiple ? 'true' : 'false'}>
  {items.map((item) => {
    const triggerId = `${accordionId}-trigger-${item.id}`;
    const panelId = `${accordionId}-panel-${item.id}`;
    const isExpanded = defaultOpenIds.has(item.id);
    const useSlot = !item.content;
    const currentSlotIndex = useSlot ? slotIndex++ : -1;

    return (
      <div class="accordion__item" data-accordion-item data-item-id={item.id}>
        <h3 class="accordion__heading">
          <button
            type="button"
            class={`accordion__trigger ${isExpanded ? 'accordion__trigger--expanded' : ''}`}
            id={triggerId}
            aria-expanded={isExpanded}
            aria-controls={panelId}
            data-accordion-trigger
          >
            <span class="accordion__title">{item.title}</span>
            <ChevronDown class="accordion__icon" width={16} height={16} aria-hidden="true" />
          </button>
        </h3>
        <div
          class={`accordion__panel ${isExpanded ? 'accordion__panel--expanded' : ''}`}
          id={panelId}
          role="region"
          aria-labelledby={triggerId}
          hidden={!isExpanded}
          data-accordion-panel
        >
          <div class="accordion__panel-inner">
            {item.content ? (
              <div class="accordion__panel-content" set:html={item.content} />
            ) : (
              <div class="accordion__panel-content accordion__panel-slot" data-accordion-slot-index={currentSlotIndex}>
                <!-- Slot content distributed by script -->
              </div>
            )}
          </div>
        </div>
      </div>
    );
  })}
  <!-- Slot content for distribution (same order as items) -->
  <div class="accordion__slot-content" style="display: none;">
    <slot />
  </div>
</div>

<script is:inline>
  (function initAccordions() {
    function initOne(accordion) {
      if (accordion.dataset.accordionInit === 'true') return;
      accordion.dataset.accordionInit = 'true';

      const isMultiple = accordion.getAttribute('data-allow-multiple') === 'true';
      const triggers = accordion.querySelectorAll('[data-accordion-trigger]');

      const setExpanded = (trigger, expanded) => {
        const panelId = trigger.getAttribute('aria-controls');
        const panel = panelId ? accordion.querySelector('#' + CSS.escape(panelId)) : null;
        trigger.setAttribute('aria-expanded', String(expanded));
        trigger.classList.toggle('accordion__trigger--expanded', expanded);
        if (panel) {
          panel.classList.toggle('accordion__panel--expanded', expanded);
          panel.hidden = !expanded;
        }
      };

      const toggle = (trigger) => {
        const expanded = trigger.getAttribute('aria-expanded') === 'true';
        if (!isMultiple) {
          triggers.forEach((t) => setExpanded(t, false));
        }
        setExpanded(trigger, !expanded);
      };

      triggers.forEach((trigger) => {
        trigger.addEventListener('click', () => toggle(trigger));
      });

      triggers.forEach((trigger, index) => {
        trigger.addEventListener('keydown', (e) => {
          let targetIndex = index;
          switch (e.key) {
            case 'ArrowDown':
              e.preventDefault();
              targetIndex = Math.min(index + 1, triggers.length - 1);
              break;
            case 'ArrowUp':
              e.preventDefault();
              targetIndex = Math.max(index - 1, 0);
              break;
            case 'Home':
              e.preventDefault();
              targetIndex = 0;
              break;
            case 'End':
              e.preventDefault();
              targetIndex = triggers.length - 1;
              break;
            case 'Enter':
            case ' ':
              e.preventDefault();
              toggle(trigger);
              return;
            default:
              return;
          }
          if (targetIndex !== index) {
            triggers[targetIndex].focus();
          }
        });
      });

      const slotContent = accordion.querySelector('.accordion__slot-content');
      if (slotContent) {
        const slotChildren = Array.from(slotContent.children);
        slotChildren.forEach((child, index) => {
          const slotPlaceholder = accordion.querySelector('[data-accordion-slot-index="' + index + '"]');
          if (slotPlaceholder) {
            slotPlaceholder.appendChild(child);
          }
        });
        slotContent.remove();
      }
    }

    function init() {
      document.querySelectorAll('[data-accordion]').forEach(initOne);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

---
import Copy from './icons/Copy.astro';
import Check from './icons/Check.astro';

interface Props {
  value: string;
  label?: string;
  format?: string;
  class?: string;
  id?: string;
}

const {
  value,
  label,
  format,
  class: className = '',
  id,
} = Astro.props;

const buttonId = id || `copy-btn-${Math.random().toString(36).substr(2, 9)}`;
---

<button
  type="button"
  class={`copy-to-clipboard ${className}`.trim()}
  data-copy-value={value}
  data-copy-format={format}
  aria-label={label || `Copy ${value} to clipboard`}
  id={buttonId}
>
  <span class="copy-to-clipboard__text">{value}</span>
  <span class="copy-to-clipboard__icon copy-to-clipboard__icon--copy" aria-hidden="true">
    <Copy width={16} height={16} />
  </span>
  <span class="copy-to-clipboard__icon copy-to-clipboard__icon--check" aria-hidden="true">
    <Check width={16} height={16} />
  </span>
  <span class="copy-to-clipboard__feedback" aria-live="polite"></span>
</button>

<script>
  (function initCopyToClipboard() {
    // Wait for DOM to be ready
    const init = () => {
      const buttons = document.querySelectorAll('.copy-to-clipboard');
      
      buttons.forEach((button) => {
        // Skip if already initialized
        if (button.hasAttribute('data-copy-initialized')) return;
        button.setAttribute('data-copy-initialized', 'true');
        
        const getValue = () => button.getAttribute('data-copy-value') || '';
        const getFormat = () => button.getAttribute('data-copy-format') || '';
        const feedback = button.querySelector('.copy-to-clipboard__feedback');
        const copyIcon = button.querySelector('.copy-to-clipboard__icon--copy');
        const checkIcon = button.querySelector('.copy-to-clipboard__icon--check');
        const textSpan = button.querySelector('.copy-to-clipboard__text');
        
        // Update text span with current value
        const updateDisplay = () => {
          const value = getValue();
          if (textSpan) {
            textSpan.textContent = value || '';
          }
        };
        
        // Initial display update
        updateDisplay();
        
        // Watch for attribute changes (for dynamic updates)
        const observer = new MutationObserver((mutations) => {
          let shouldUpdate = false;
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes') {
              if (mutation.attributeName === 'data-copy-value' || mutation.attributeName === 'data-copy-format') {
                shouldUpdate = true;
              }
            }
          });
          if (shouldUpdate) {
            // Use requestAnimationFrame to ensure DOM is ready
            requestAnimationFrame(() => {
              updateDisplay();
            });
          }
        });
        observer.observe(button, {
          attributes: true,
          attributeFilter: ['data-copy-value', 'data-copy-format'],
          attributeOldValue: false
        });
        
        // Listen for custom value-updated event
        button.addEventListener('value-updated', (event) => {
          if (event && event.detail && event.detail.value) {
            updateDisplay();
          }
        });
        
        // Fallback: Periodically check for value changes (in case MutationObserver misses something)
        let lastValue = getValue();
        const intervalId = setInterval(() => {
          const currentValue = getValue();
          if (currentValue !== lastValue) {
            lastValue = currentValue;
            updateDisplay();
          }
        }, 300);
        
        // Store interval ID for potential cleanup (though we don't need to clean it up in this case)
        button.setAttribute('data-copy-interval-id', intervalId.toString());
        
        const copyToClipboard = async () => {
          // Always read fresh value on click (in case it was updated dynamically)
          let value = getValue();
          const format = getFormat();
          
          // If value is still empty, try reading from text span as fallback
          if (!value && textSpan) {
            value = textSpan.textContent || '';
          }
          
          if (!value) {
            return;
          }
          
          try {
            await navigator.clipboard.writeText(value);
            
            // Show success state
            if (copyIcon) copyIcon.classList.add('copy-to-clipboard__icon--hidden');
            if (checkIcon) checkIcon.classList.remove('copy-to-clipboard__icon--hidden');
            if (feedback) {
              feedback.textContent = format ? `Copied ${format}!` : 'Copied!';
            }
            
            // Reset after 2 seconds
            setTimeout(() => {
              if (copyIcon) copyIcon.classList.remove('copy-to-clipboard__icon--hidden');
              if (checkIcon) checkIcon.classList.add('copy-to-clipboard__icon--hidden');
              if (feedback) {
                feedback.textContent = '';
              }
            }, 2000);
          } catch (err) {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = value;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
              document.execCommand('copy');
              if (copyIcon) copyIcon.classList.add('copy-to-clipboard__icon--hidden');
              if (checkIcon) checkIcon.classList.remove('copy-to-clipboard__icon--hidden');
              if (feedback) {
                feedback.textContent = format ? `Copied ${format}!` : 'Copied!';
              }
              
              setTimeout(() => {
                if (copyIcon) copyIcon.classList.remove('copy-to-clipboard__icon--hidden');
                if (checkIcon) checkIcon.classList.add('copy-to-clipboard__icon--hidden');
                if (feedback) {
                  feedback.textContent = '';
                }
              }, 2000);
            } catch (fallbackErr) {
              if (feedback) {
                feedback.textContent = 'Failed to copy';
              }
            }
            
            document.body.removeChild(textArea);
          }
        };
        
        button.addEventListener('click', copyToClipboard);
        
        // Keyboard support
        button.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            copyToClipboard();
          }
        });
      });
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

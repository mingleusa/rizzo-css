---
import SearchIcon from './icons/Search.astro';
import Close from './icons/Close.astro';
import Cmd from './icons/Cmd.astro';
interface Props { id?: string; }
const { id = 'search-main' } = Astro.props;
---
<div class="search" data-search>
  <div class="search__trigger-wrapper">
    <button type="button" class="search__trigger" aria-label="Open search" aria-expanded="false" aria-controls="{id}-panel" data-search-trigger>
      <SearchIcon width={20} height={20} class="search__icon" />
      <span class="search__trigger-text">Search</span>
      <kbd class="search__kbd" aria-hidden="true">
        <span class="search__kbd-modifier"><Cmd width={14} height={14} /></span>
        <kbd>K</kbd>
      </kbd>
    </button>
  </div>
  <div class="search__overlay" id="{id}-panel" aria-hidden="true" role="dialog" aria-modal="true" data-search-overlay>
    <div class="search__panel" role="dialog" aria-modal="true" aria-labelledby="{id}-title" aria-hidden="true" tabindex="-1">
      <h2 id="{id}-title" class="sr-only">Search</h2>
      <div class="search__header">
        <div class="search__input-wrapper">
          <SearchIcon width={20} height={20} class="search__input-icon" aria-hidden="true" />
          <input type="search" class="search__input" placeholder="Search…" aria-label="Search" />
        </div>
        <button type="button" class="search__close-btn" aria-label="Close search" data-search-close>
          <Close width={20} height={20} aria-hidden="true" />
        </button>
      </div>
      <div class="search__results" role="listbox" aria-label="Search results">
        <div class="search__empty">
          <p class="search__empty-text">Start typing to search…</p>
        </div>
        <div class="search__results-list" role="group" aria-label="Sample results">
          <a href="#" class="search__result-item" tabindex="-1" data-search-result-item><div class="search__result-category">Docs</div><div class="search__result-title">Getting started</div></a>
          <a href="#" class="search__result-item" tabindex="-1" data-search-result-item><div class="search__result-category">Docs</div><div class="search__result-title">Components</div></a>
          <a href="#" class="search__result-item" tabindex="-1" data-search-result-item><div class="search__result-category">Docs</div><div class="search__result-title">Theming</div></a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function initSearch() {
    var focusableSel = 'button:not([disabled]),a[href],input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex="-1"])';
    function getFocusable(container) {
      return Array.prototype.slice.call(container.querySelectorAll(focusableSel));
    }
    function init() {
      document.querySelectorAll('[data-search]').forEach(function (search) {
        if (search.__searchInited) return;
        search.__searchInited = true;
        var trigger = search.querySelector('.search__trigger');
        var overlay = search.querySelector('[data-search-overlay]');
        var panel = search.querySelector('.search__panel');
        var input = search.querySelector('.search__input');
        var closeBtn = search.querySelector('[data-search-close]');
        var resultItems = search.querySelectorAll('.search__result-item, [data-search-result-item]');
        if (!trigger || !overlay || !panel || !input) return;
        var previousActive = null;
        var focusTrapHandler = null;
        function openSearch() {
          previousActive = document.activeElement;
          overlay.setAttribute('aria-hidden', 'false');
          panel.setAttribute('aria-hidden', 'false');
          panel.setAttribute('data-open', 'true');
          trigger.setAttribute('aria-expanded', 'true');
          for (var i = 0; i < resultItems.length; i++) resultItems[i].setAttribute('tabindex', '0');
          input.focus();
          focusTrapHandler = function (e) {
            if (panel.getAttribute('data-open') !== 'true') return;
            if (e.key === 'Escape') { e.preventDefault(); closeSearch(); return; }
            if (e.key === 'Tab') {
              var els = getFocusable(panel);
              if (els.length === 0) return;
              var first = els[0], last = els[els.length - 1], active = document.activeElement;
              if (e.shiftKey) {
                if (active === first || !panel.contains(active)) { e.preventDefault(); last.focus(); }
              } else {
                if (active === last || !panel.contains(active)) { e.preventDefault(); first.focus(); }
              }
            }
          };
          document.addEventListener('keydown', focusTrapHandler);
        }
        function closeSearch() {
          document.removeEventListener('keydown', focusTrapHandler);
          focusTrapHandler = null;
          panel.removeAttribute('data-open');
          panel.setAttribute('aria-hidden', 'true');
          overlay.setAttribute('aria-hidden', 'true');
          trigger.setAttribute('aria-expanded', 'false');
          for (var i = 0; i < resultItems.length; i++) resultItems[i].setAttribute('tabindex', '-1');
          if (previousActive && previousActive.focus) previousActive.focus();
          previousActive = null;
        }
        trigger.addEventListener('click', function () {
          if (panel.getAttribute('data-open') === 'true') closeSearch();
          else openSearch();
        });
        if (closeBtn) closeBtn.addEventListener('click', closeSearch);
        overlay.addEventListener('click', function (e) {
          if (e.target === overlay) closeSearch();
        });
        input.addEventListener('keydown', function (e) {
          if (e.key === 'Escape') { e.preventDefault(); closeSearch(); }
        });
        search.__searchOpen = openSearch;
        search.__searchClose = closeSearch;
      });
      if (!window.__rizzoSearchCmdK) {
        window.__rizzoSearchCmdK = true;
        document.addEventListener('keydown', function (e) {
          var isMod = e.ctrlKey || e.metaKey;
          var isK = e.key === 'k' || e.key === 'K';
          if (!isMod || !isK) return;
          var searchEl = document.querySelector('[data-search]');
          if (!searchEl || !searchEl.__searchOpen) return;
          var panelEl = searchEl.querySelector('.search__panel');
          if (!panelEl) return;
          var target = e.target;
          var inOtherInput = target && !searchEl.contains(target) && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable === true || (target.closest && target.closest('input, textarea, [contenteditable="true"]')));
          var isOpen = panelEl.getAttribute('data-open') === 'true';
          if (isOpen || !inOtherInput) {
            e.preventDefault();
            e.stopPropagation();
            if (isOpen) searchEl.__searchClose(); else searchEl.__searchOpen();
          }
        }, true);
      }
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
  })();
</script>
